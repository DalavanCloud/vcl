This file explains how to upgrade an existing install of Apache VCL 2.1 or 2.2
to Apache VCL 2.2.1. It assumed that you extracted the release archive
to /root/apache-VCL-2.2.1-incubating

The basic steps that will be performed:

1. Shutdown httpd and vcld services
2. Create backup of vcl database
3. Update mysql schema
4. Grant CREATE TEMPORARY TABLES to mysql user
5. Update Web code, create a backup, copy in new, make changes
6. Restart httpd service
7. Update Management node vcl code, create a backup, copy in new, make changes
8. Restart vcld service


1. Shutdown httpd and vcld services

   service httpd stop
	service vcld stop

2. Create a backup of vcl database

We will create a backup of the vcl database. This will provide a restore point
if necessary.

   mysqldump vcl > ~/vcl-pre2.2.1-upgrade.sql

3. Update mysql schema

This step updates the mysql schema.

   cd /root/apache-VCL-2.2.1-incubating
   mysql vcl < mysql/update-vcl.sql

4. Grant CREATE TEMPORARY TABLES to mysql user

The web code now requires access to create temporary tables in mysql. You need
to grant the user your web code uses to access mysql the "CREATE TEMPORARY
TABLES" permission. Look at the secrets.php file in your web code for the user
and hostname. For example, if your web code is installed at /var/www/html/vcl,
your secrets.php file would be /var/www/html/vcl/.ht-inc/secrets.php. Look for
$vclhost and $vclusername. The secrets.php file might have something like:

$vclhost = 'localhost';
$vcluser = 'vcluser';

Then, you need to issue the grant command to mysql. Using the values from above
as examples, connect to mysql and then issue the grant command:

mysql
GRANT CREATE TEMPORARY TABLES ON `vcl`.* TO 'vcluser'@'localhost';
exit

5. Update web code

This step we will move the existing web directory out of the way, so we can copy
in the new web code base. After copying in the new code, we will migrate your
configuration changes. These instructions assume that you installed the vcl web
code at /var/www/html/vcl. If you installed it elsewhere, replace
/var/www/html/vcl with your vcl web root.

   a. copy your old code out of the way

      cd /var/www/html
		mv vcl ~/vcl-pre2.2.1_web

	b. copy the new code in place

	   cd /root/apache-VCL-2.2.1-incubating
		cp -r web /var/www/html/vcl

	c. copy your config files from the previous version:

	   cd ~/vcl-pre2.2.1_web/.ht-inc
		cp conf.php secrets.php pubkey.pem keys.pem /var/www/html/vcl/.ht-inc

	d. (2.1 -> 2.2.1 only) make /var/www/html/vcl/.ht-inc/maintenance writable by
		the web server - if httpd on your server is running as the user apache:

	   chown apache /var/www/html/vcl/.ht-inc/maintenance

	e. (2.1 -> 2.2.1 only) add the following new entries to conf.php - You can copy
		them in from .ht-inc/conf-default.php. Descriptions of each item can also be
		found in conf-default.php

	   * date_default_timezone_set('America/New_York');
		* $blockNotifyUsers = "adminuser@example.org";
		* define("SCHEDULER_ALLOCATE_RANDOM_COMPUTER", 0);
		* define("DOCUMENTATIONURL", "https://cwiki.apache.org/VCLDOCS/");
		* define("USEFILTERINGSELECT", 1);
		* define("FILTERINGSELECTTHRESHOLD", 1000);
		* define("DEFAULTTHEME", 'default');

6. Restart httpd service

	service httpd start

7. Update management node code

This step will move the existing vcl code base out of the way, so we can cleanly
copy in the new management node code.

	a. Copy the existing management node code base to a backup location

		cd <your vcl MN code root path>
		ie. cd /usr/local/
		cp -r vcl ~/vcl-pre2.2.1_managementnode

	b. Copy in the 2.2.1 code base to /usr/local, copying in should preserve any
	drivers or other files you've added.

		/bin/cp -r /root/apache-VCL-2.2.1-incubating/managementnode/* /usr/local/vcl

	c. (2.1 -> 2.2.1 only) Make changes related to vcld.conf settings

	   * Open VCL web interface
		* Go to Management Nodes
		* Select Edit Management Node Information
		* Select Edit.
		* Set any relevant fields:
		* SysAdmin Email Address(es) - comma delimited list of vcl admin email
		  addresses
		* Address for Shadow Emails - a shared mail box, optional it receives
		  email of all notifications
		* Public NIC configuration method - Defines what type of NIC configuration
		  is used, options are dynamic DHCP, Manual DHCP, or static
		* End Node SSH Identity Key Files

8. Restart vcld service

	service vcld start
